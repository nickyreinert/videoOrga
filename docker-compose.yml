services:
  video-tagger:
    build: 
      context: .
      args:
          - BUILDKIT_INLINE_CACHE=1
    ports:
      - "5000:5000"
    volumes:
      # Mount the application source code and data directories
      - type: bind
        source: ./app
        target: /app
      - type: bind
        source: ./data
        target: /app/data

      # Mount video directory (read-only)
      - type: bind
        source: /e/OneDrive/Videos
        target: /videos
        read_only: true

      # Mount cache directory for model and torch caches         
      - type: bind
        source: ./cache
        target: /cache

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - VIDEO_BASE_PATH=/videos
      - VIDEO_DB_PATH=/app/data/video_metadata.db # Point DB to the correct mounted path
      - FLASK_APP=web/app.py
      - PYTHONUNBUFFERED=1
      # Cache/config locations for transformers / torch / huggingface
      - HF_HOME=/cache/huggingface
      - TORCH_HOME=/cache/torch
      - XDG_CACHE_HOME=/cache/other
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    restart: unless-stopped
    
    # Use Flask's development server with reload enabled
    command: python3 -m flask run --host=0.0.0.0 --reload
