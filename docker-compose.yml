
services:
  video-tagger:
    build: 
      context: .
      args:
          - BUILDKIT_INLINE_CACHE=1
    ports:
      - "5000:5000"
    volumes:
      # Mount video directory (read-only)
      - type: bind
        source: /e/OneDrive/Videos
        target: /videos
        read_only: true
      # Mount for persistent data (database, thumbnails, cache)
      - type: bind
        source: ./data
        target: /app/data
      # Mount for model/cache files to avoid re-downloading large models
      - type: bind
        # Use a local folder in the project for cached models (relative paths
        # work with Docker Compose; on Windows this will be under the repo root)
        source: ./model_cache
        target: /app/models
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - VIDEO_BASE_PATH=/videos
      - FLASK_ENV=production
      - PYTHONUNBUFFERED=1
      # Cache/config locations for transformers / torch / huggingface
      - HF_HOME=/app/models/huggingface
      - TORCH_HOME=/app/models/torch
      - XDG_CACHE_HOME=/app/models/cache
  # TRANSFORMERS_CACHE is deprecated in transformers v5; use HF_HOME instead
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

volumes:
  video_data:
    # Named volume for persistent data