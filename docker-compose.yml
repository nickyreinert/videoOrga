services:
  video-tagger:
    build: 
      context: .
      args:
          - BUILDKIT_INLINE_CACHE=1
    ports:
      - "5000:5000"
    volumes:
      - type: bind
        source: ./
        target: /app
        # Exclude patterns to avoid conflicts
      
      # Mount video directory (read-only)
      - type: bind
        source: /e/OneDrive/Videos
        target: /videos
        read_only: true
      
      # Mount for persistent data (database, thumbnails, cache)
      - type: bind
        source: ./data
        target: /app/data
      
      # Mount for model/cache files to avoid re-downloading large models
      - type: bind
        source: ./model_cache
        target: /app/models

      # Mount for model/cache files to avoid re-downloading large models
      - type: bind
        source: ./torch-cache
        target: /torch-cache

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - VIDEO_BASE_PATH=/videos
      - FLASK_APP=web/app.py   # >>> NEW: Point to the Flask app location <<<
      - FLASK_ENV=development  # Changed to development for auto-reload
      - FLASK_DEBUG=1          # Enable debug mode for live reload
      - PYTHONUNBUFFERED=1
      # Cache/config locations for transformers / torch / huggingface
      - HF_HOME=/app/models/huggingface
      - TORCH_HOME=/app/models/torch
      - XDG_CACHE_HOME=/app/models/cache
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    restart: unless-stopped
    
    # >>> NEW: Override command to use Flask development server <<<
    command: python3 -m flask run --host=0.0.0.0 --reload

volumes:
  video_data:
    # Named volume for persistent data