services:
  video-tagger:
    build: 
      context: .
    ports:
      - "5000:5000"
    volumes:
      - type: bind
        source: ./app
        target: /app
        # Exclude patterns to avoid conflicts
      
      # Mount video directory (read-only)
      - type: bind
        source: /e/OneDrive/Videos
        target: /videos
        read_only: true
      
      # Mount for persistent data (database, thumbnails, cache)
      - type: bind
        source: ./data
        target: /data

      # Mount for model/cache files to avoid re-downloading large models
      - type: bind
        source: ./cache
        target: /cache

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - VIDEO_BASE_PATH=/videos
      - FLASK_APP=web/app.py   # >>> NEW: Point to the Flask app location <<<
      - FLASK_ENV=development  # Changed to development for auto-reload
      - FLASK_DEBUG=1          # Enable debug mode for live reload
      - PYTHONUNBUFFERED=1
      # Cache/config locations for transformers / torch / huggingface
      - HF_HOME=/cache/models/huggingface
      - WHISPER_CACHE=/cache/models/whisper
      - TRANSFORMERS_CACHE=/cache/transformers
      - MODELS_CACHE=/cache/models
      - TORCH_HOME=/cache/models/torch
      - XDG_CACHE_HOME=/cache/models/other
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    restart: unless-stopped
    
    # Use the 'serve' command from the entrypoint script.
    # This ensures wait_for_gpu and init_database are called before starting the server.
    # The entrypoint's 'serve' block will then start the Flask app.
    command: serve

volumes:
  video_data:
    # Named volume for persistent data